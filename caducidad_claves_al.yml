---
- name: Verificar caducidad de contrase√±as y enviar alerta por Telegram
  hosts: all
  become: yes
  vars:
    # Configuraci√≥n de Telegram
    telegram_bot_token: "7752861813:AAFmFHaKUIPgo9Qsr5sS2DDV_vSbCv9t4wY"
    telegram_chat_id: "@andyjvf_bot"
    dias_alerta: 30                      # Alertar cuando falten 30 d√≠as para expirar
    
    # Configuraci√≥n de pol√≠ticas de contrase√±as
    max_dias_clave: 90                   # M√°ximo de d√≠as para cambiar la contrase√±a
    min_dias_clave: 1                    # M√≠nimo de d√≠as para cambiar la contrase√±a
    dias_aviso_clave: 30                 # D√≠as de aviso antes de expirar

  tasks:
    - name: Obtener informaci√≥n de expiraci√≥n de contrase√±as
      shell: |
        cat /etc/shadow | awk -F: '{
          if ($2 != "*" && $2 != "!!") {
            cmd = "date -d \""$3" days\" +%s";
            cmd | getline last_change;
            close(cmd);
            cmd = "date +%s";
            cmd | getline now;
            close(cmd);
            max_days = $5;
            if (max_days == "") max_days = {{ max_dias_clave }};
            expire = last_change + (max_days * 86400);
            remaining = (expire - now)/86400;
            if (remaining < {{ dias_alerta }} && remaining > 0) {
              print $1":"int(remaining)" d√≠as";
            }
          }
        }'
      register: usuarios_por_expiar
      changed_when: false

    - name: Enviar alerta por Telegram si hay usuarios con contrase√±a por expirar
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: |
            üîî **Alerta de Caducidad de Contrase√±as** üîî
            üñ•Ô∏è Host: {{ inventory_hostname }}
            üìÖ Pol√≠tica: Cambio cada {{ max_dias_clave }} d√≠as (Aviso a {{ dias_aviso_clave }} d√≠as)
            
            üë§ Usuarios con contrase√±a por expirar:
            {% if usuarios_por_expiar.stdout_lines %}
            {% for usuario in usuarios_por_expiar.stdout_lines %}
            - {{ usuario }}
            {% endfor %}
            {% else %}
            ‚úÖ No hay usuarios con contrase√±a por expirar.
            {% endif %}
            
            ‚è≥ Pr√≥ximo chequeo: {{ ansible_date_time.date }}
          parse_mode: "markdown"
      when: usuarios_por_expiar.stdout_lines | length > 0
      delegate_to: localhost
      run_once: true

    - name: Enviar confirmaci√≥n cuando no hay usuarios por expirar
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: |
            üîç **Verificaci√≥n de Contrase√±as Completa**
            üñ•Ô∏è Host: {{ inventory_hostname }}
            ‚úÖ Resultado: No hay usuarios con contrase√±a por expirar en los pr√≥ximos {{ dias_alerta }} d√≠as
            üìÖ Pr√≥ximo chequeo: {{ ansible_date_time.date }}
          parse_mode: "markdown"
      when: usuarios_por_expiar.stdout_lines | length == 0
      delegate_to: localhost
      run_once: true
